<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
<mapper namespace="mbr">

    <insert id="insertMbr">
        INSERT  INTO MBR    (
                                MBR_NO     
                              , MBR_EMAIL  
                              , MBR_PW     
                              , MBR_NKNM   
                              , MBR_STAT_CD 
                              , MBR_SX_CD   
                              , MBR_INTRO  
                              , MBR_JN_DTT  
                              , PW_ERR_CNT  
                              , PREV_PW    
                              , PW_CHG_DTT  
                              , LAST_LGN_DTT
                              , MBR_WTHD_DTT
                            )
        SELECT
                (SELECT CONCAT('M', RIGHT(1000000000 + SUBSTR(MAX(MBR_NO), 2, 10) + 1, 9)) FROM MBR)
              , #{mbrEmail}
              , SHA2(#{mbrPw}, 256)
              , #{mbrNknm}   
              , '109101'    /* 사용중 */
              , '110103'    /* 성별 모름 */
              , NULL  
              , NOW() 
              , 0  
              , NULL
              , NULL 
              , NULL
              , NULL
    </insert>

    <select id="selectMbrEmailCnt">
        SELECT  COUNT(*) cnt
        FROM    MBR
        WHERE   MBR_EMAIL = #{mbrEmail}
    </select>

    <select id="selectMbrInfo">
        SELECT  
                MBR_NO
              , MBR_EMAIL
              , MBR_NKNM
              , MBR_INTRO
              , C.COM_CD_NM MBR_STAT
              , C2.COM_CD_NM MBR_SX
              , MBR_JN_DTT
              , PW_ERR_CNT
              , PREV_PW
              , PW_CHG_DTT
              , LAST_LGN_DTT
              , MBR_WTHD_DTT
        FROM    MBR         M
        JOIN    COM_CODE    C
        ON      M.MBR_STAT_CD = C.COM_CD
        JOIN    COM_CODE    C2
        ON      M.MBR_SX_CD = C2.COM_CD
        WHERE   1 = 1
        AND     (#{mbrNo} IS NULL OR MBR_NO = #{mbrNo})
        AND     (#{mbrEmail} IS NULL OR MBR_EMAIL = #{mbrEmail})
        <if test="mbrPw != null and mbrPw != ''">
        AND     MBR_PW = SHA2(#{mbrPw}, 256)
        </if>
    </select>

</mapper>